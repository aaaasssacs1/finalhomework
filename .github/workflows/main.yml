name: Windows Build

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 安装 Qt6 (使用 MSVC 版本，兼容性更好)
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64' # 改用 MSVC
        modules: 'qtcharts'

    # 3. 安装 libmodbus (使用 vcpkg，自动适配 MSVC)
    - name: Install libmodbus via vcpkg
      run: |
        vcpkg install libmodbus:x64-windows
        vcpkg integrate install

    # 4. 编译 (使用 CMake + MSVC)
    - name: Configure and Build
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        mkdir build
        cd build
        
        :: 配置 CMake，指定使用 vcpkg 的工具链文件来查找库
        cmake .. -G "NMake Makefiles" ^
                 -DCMAKE_BUILD_TYPE=Release ^
                 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        
        :: 开始编译
        nmake

    # 5. 打包
    - name: Package
      shell: cmd
      run: |
        :: 重新加载 MSVC 环境，确保 windeployqt 能找到 VC 运行时库
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        
        cd build
        mkdir release_output
        
        :: 1. 复制主程序
        copy PlcMonitor.exe release_output\
        
        :: 2. 调试：列出 vcpkg bin 目录的内容（如果失败，方便查看文件名）
        echo List of vcpkg bin files:
        dir C:\vcpkg\installed\x64-windows\bin\
        
        :: 3. 智能复制 libmodbus DLL (使用通配符匹配 libmodbus.dll 或 modbus.dll)
        copy C:\vcpkg\installed\x64-windows\bin\*modbus*.dll release_output\
        
        :: 4. 运行 windeployqt
        windeployqt --release --compiler-runtime release_output\PlcMonitor.exe
        
    # 6. 上传结果 (修复了版本号 v3 -> v4)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4  # <--- 这里必须是 v4
      with:
        name: PlcMonitor-Windows
        path: build/release_output/
